<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <meta name="color-scheme" content="dark light" />
  <title>Anchored Landscaping Invoice</title>

  <style>
    :root{
      --bg:#0b1220; --card:#111827; --card2:#0f172a; --text:#e5e7eb; --muted:#9ca3af;
      --line:#1f2937; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --info:#60a5fa;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--text); }
    a{ color:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .topbar{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logoMark{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(34,197,94,.9), rgba(17,24,39,.9));
      display:grid; place-items:center; font-weight:900;
    }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:13px; margin-top:4px; line-height:1.35; }

    .grid{ display:grid; gap:12px; margin-top:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.25fr .75fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px; font-size:15px; color:#f3f4f6; }
    .row{ display:grid; gap:10px; }
    .row2{ display:grid; gap:10px; }
    @media (min-width: 720px){ .row2{ grid-template-columns: 1fr 1fr; } }
    .row3{ display:grid; gap:10px; }
    @media (min-width: 900px){ .row3{ grid-template-columns: 1fr 1fr 1fr; } }

    label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn.primary{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35); }
    .btn.info{ background: rgba(96,165,250,.12); border-color: rgba(96,165,250,.35); }
    .btn.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
    .btn.danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius:10px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .muted{ color:var(--muted); font-size:12px; line-height:1.35; }

    .tableWrap{ overflow:auto; border-radius:14px; border:1px solid var(--line); background: rgba(255,255,255,.02); }
    table{ width:100%; border-collapse:collapse; min-width:980px; }
    th, td{ padding:10px; border-bottom:1px solid var(--line); vertical-align:top; }
    th{ position:sticky; top:0; background: var(--card2); text-align:left; font-size:12px; color:#cbd5e1; }
    td{ font-size:13px; }
    tr:last-child td{ border-bottom:none; }
    .cellMini{ font-size:12px; color:var(--muted); margin-top:6px; line-height:1.25; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line); color:#d1d5db;
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

    .rightCol .card{ position:sticky; top:14px; }
    .totals{ display:grid; gap:8px; margin-top:10px; }
    .totRow{ display:flex; justify-content:space-between; gap:12px; font-size:13px; color:#e5e7eb; }
    .totRow .k{ color:var(--muted); }
    .totRow.big{ font-size:16px; font-weight:900; padding-top:10px; border-top:1px solid var(--line); }
    .hr{ height:1px; background: var(--line); margin:12px 0; }

    .details{
      border:1px dashed var(--line);
      background: rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      margin-top:8px;
    }

    /* PWA floating buttons */
    .pwa-fab{
      position:fixed; right:14px; bottom:14px; z-index:9999;
      display:flex; gap:8px; align-items:center;
    }

    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; z-index:10000;
      padding:18px;
    }
    .modal{
      width:min(720px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
    }
    .modal h3{ margin:0 0 10px; font-size:16px; }
    .preview{
      display:flex; gap:10px; align-items:center; margin-top:10px;
      padding:10px; border:1px dashed var(--line); border-radius:14px;
      background:rgba(255,255,255,.03);
    }
    .preview img{ width:44px; height:44px; border-radius:12px; border:1px solid var(--line); object-fit:cover; background:#0b1220; }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid var(--line); background: rgba(255,255,255,.03); color:#d1d5db;}

    /* Print */
    @media print{
      body{ background:#fff; color:#000; }
      .card{ box-shadow:none; }
      .pwa-fab, .noPrint{ display:none !important; }
      .wrap{ max-width:none; padding:0; }
      .grid{ grid-template-columns: 1.2fr .8fr; gap:10px; }
      .card{ border:1px solid #ddd; background:#fff; }
      input, select, textarea{ border:1px solid #ddd; color:#000; background:#fff; }
      th{ background:#f3f4f6; color:#111827; }
      .tableWrap{ border:1px solid #ddd; }
      .pill{ border:1px solid #ddd; background:#fff; color:#111827; }
      .muted, label, .sub, .cellMini{ color:#374151; }
      .totRow .k{ color:#374151; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logoMark">A</div>
        <div>
          <h1 id="appTitle">Anchored Landscaping LLC ‚Äî Invoice</h1>
          <div class="sub" id="appSub">
            217-597-8466 ‚Ä¢ 303 James St, Saint Joseph, IL 61873
          </div>
          <div class="sub">
            Pricing Assistant is built-in: enter real measurements (sq ft / cu yd / linear ft) to get suggestions you can apply with one click.
          </div>
        </div>
      </div>

      <div class="actions noPrint">
        <button class="btn info" id="btnNewInvoice" type="button">üßæ New Invoice</button>
        <button class="btn" id="btnSave" type="button">üíæ Save</button>
        <button class="btn warn" id="btnExport" type="button">üñ®Ô∏è Print / PDF</button>
        <button class="btn danger" id="btnResetAll" type="button">‚ôªÔ∏è Reset All</button>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <h2>Invoice Details</h2>
          <div class="row3">
            <div>
              <label>Invoice #</label>
              <input id="invoiceNo" />
            </div>
            <div>
              <label>Job Date</label>
              <input id="jobDate" type="date" />
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="Unpaid">Unpaid</option>
                <option value="Paid">Paid</option>
                <option value="Estimate">Estimate</option>
              </select>
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Customer Name</label>
              <input id="custName" placeholder="Customer name" />
            </div>
            <div>
              <label>Customer Phone (optional)</label>
              <input id="custPhone" placeholder="(###) ###-####" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Service Address</label>
              <input id="custAddress" placeholder="Service address" />
            </div>
            <div>
              <label>Email (optional)</label>
              <input id="custEmail" placeholder="email@example.com" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>Notes / Scope</label>
              <textarea id="notes" placeholder="Describe the job, warranty, payment terms, etc."></textarea>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Pricing Assistant Settings</h2>
          <div class="muted">
            These settings power the suggestions. Nothing is locked ‚Äî you can always override rates.
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Target labor rate ($/hr)</label>
              <input id="setLaborRate" type="number" step="0.01" />
            </div>
            <div>
              <label>Overhead (%)</label>
              <input id="setOverheadPct" type="number" step="0.1" />
            </div>
            <div>
              <label>Profit (%)</label>
              <input id="setProfitPct" type="number" step="0.1" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Travel time per job (minutes)</label>
              <input id="setTravelMins" type="number" step="1" />
            </div>
            <div>
              <label>Minimum job fee ($)</label>
              <input id="setMinJobFee" type="number" step="0.01" />
            </div>
            <div>
              <label>Helper labor minutes (setup/cleanup)</label>
              <input id="setHelperMins" type="number" step="1" />
            </div>
          </div>

          <div class="hr"></div>

          <h2 style="margin-top:0;">Production Rates + Material Costs</h2>

          <div class="row3">
            <div>
              <label>Mowing production (sq ft / hr)</label>
              <input id="rateMowSqftHr" type="number" step="1" />
            </div>
            <div>
              <label>Edging/Trimming (linear ft / hr)</label>
              <input id="rateEdgeLfHr" type="number" step="1" />
            </div>
            <div>
              <label>Weeding (sq ft / hr)</label>
              <input id="rateWeedSqftHr" type="number" step="1" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Mulch install (cu yd / hr)</label>
              <input id="rateMulchCuydHr" type="number" step="0.01" />
            </div>
            <div>
              <label>Rock/Gravel (tons / hr)</label>
              <input id="rateRockTonHr" type="number" step="0.01" />
            </div>
            <div>
              <label>Soil/Topsoil (cu yd / hr)</label>
              <input id="rateSoilCuydHr" type="number" step="0.01" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Sod install (sq ft / hr)</label>
              <input id="rateSodSqftHr" type="number" step="1" />
            </div>
            <div>
              <label>Hedge trimming (linear ft / hr)</label>
              <input id="rateHedgeLfHr" type="number" step="1" />
            </div>
            <div>
              <label>Bush trimming (bushes / hr)</label>
              <input id="rateBushPerHr" type="number" step="1" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Leaf cleanup (sq ft / hr)</label>
              <input id="rateLeafSqftHr" type="number" step="1" />
            </div>
            <div>
              <label>Dump fee default ($)</label>
              <input id="matDumpFee" type="number" step="0.01" />
            </div>
            <div>
              <label>Supplies / misc per job ($)</label>
              <input id="matSupplies" type="number" step="0.01" />
            </div>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>Mulch material cost ($/cu yd)</label>
              <input id="matMulch" type="number" step="0.01" />
            </div>
            <div>
              <label>Rock/Gravel material ($/ton)</label>
              <input id="matRock" type="number" step="0.01" />
            </div>
            <div>
              <label>Soil/Topsoil material ($/cu yd)</label>
              <input id="matSoil" type="number" step="0.01" />
            </div>
          </div>

          <div class="row2" style="margin-top:10px;">
            <div>
              <label>Sod material cost ($/sq ft)</label>
              <input id="matSod" type="number" step="0.01" />
            </div>
            <div>
              <label>Tax (%) (optional)</label>
              <input id="taxPct" type="number" step="0.1" />
            </div>
          </div>

          <div class="details">
            <div class="muted">
              Tip: For suggestions, the app estimates labor time using your production rates + helper minutes + travel minutes,
              then adds overhead and profit. You can apply suggestions per line with <span class="kbd">Use Suggestion</span>.
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h2>Line Items</h2>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:200px;">Service</th>
                  <th style="min-width:250px;">Measurements (for suggestion)</th>
                  <th style="min-width:120px;">Qty</th>
                  <th style="min-width:130px;">Rate</th>
                  <th style="min-width:140px;">Line Total</th>
                  <th style="min-width:260px;">Assistant</th>
                  <th class="noPrint" style="min-width:110px;">Actions</th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
            </table>
          </div>

          <div class="actions noPrint" style="margin-top:12px;">
            <button class="btn primary" id="btnAddCustom" type="button">‚ûï Add Custom Item</button>
            <button class="btn" id="btnAddDefaults" type="button">üìå Restore Default Services</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            Market note: suggestions are based on your settings + measurements. Always adjust for your local market and job complexity.
          </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card">
          <h2>Business Info</h2>
          <div class="row">
            <div>
              <label>Business Name</label>
              <input id="bizName" />
            </div>
            <div>
              <label>Phone</label>
              <input id="bizPhone" />
            </div>
            <div>
              <label>Address</label>
              <input id="bizAddress" />
            </div>
          </div>

          <div class="hr"></div>

          <h2>Totals</h2>
          <div class="totals">
            <div class="totRow"><div class="k">Subtotal</div><div id="subTotal">$0.00</div></div>
            <div class="totRow">
              <div class="k">Tax</div>
              <div id="taxTotal">$0.00</div>
            </div>
            <div class="totRow">
              <div class="k">Discount (optional)</div>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="discountAmt" type="number" step="0.01" style="width:120px;" />
              </div>
            </div>
            <div class="totRow big"><div class="k">Grand Total</div><div id="grandTotal">$0.00</div></div>
          </div>

          <div class="hr"></div>

          <div class="actions noPrint">
            <button class="btn info" id="btnQuoteEmail" type="button">‚úâÔ∏è Copy Summary</button>
          </div>
          <div class="muted" id="summaryHint" style="margin-top:10px;">
            ‚ÄúCopy Summary‚Äù puts a clean invoice summary on your clipboard for texting/emailing customers.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PWA floating buttons -->
  <div class="pwa-fab noPrint" aria-label="PWA controls">
    <button class="btn" id="btnPwaSettings" type="button" title="PWA Settings">‚öôÔ∏è</button>
    <button class="btn primary" id="btnInstall" type="button" style="display:none;" title="Install app">Install</button>
  </div>

  <!-- PWA Settings Modal -->
  <div class="modal-backdrop" id="pwaModalBackdrop" role="dialog" aria-modal="true" aria-label="PWA Settings">
    <div class="modal">
      <h3>PWA Settings (App Name + Icon)</h3>
      <div class="muted">
        To change the icon later: upload a PNG to your repo (example: <span class="kbd">icon-512.png</span>) or use any HTTPS image URL, paste it below, and Save.
        If the app is already installed, you may need to remove & reinstall to see the new home screen icon (browser behavior).
      </div>

      <div class="row2" style="margin-top:12px;">
        <div>
          <label for="pwaName">App name</label>
          <input id="pwaName" placeholder="e.g., Anchored Landscaping Invoice" />
        </div>
        <div>
          <label for="pwaIconUrl">Icon image URL (PNG recommended)</label>
          <input id="pwaIconUrl" placeholder="https://your-site.com/icon-512.png" />
        </div>
      </div>

      <div class="preview">
        <img id="pwaIconPreview" alt="Icon preview" />
        <div>
          <div id="pwaNamePreview" style="font-weight:900;">App Name</div>
          <div class="muted" id="pwaIconPreviewText">Using default icon</div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px; justify-content:flex-end;">
        <button class="btn" id="btnClosePwa" type="button">Close</button>
        <button class="btn" id="btnResetPwa" type="button">Reset</button>
        <button class="btn primary" id="btnSavePwa" type="button">Save</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Storage + Defaults
     ***********************/
    const STORE_KEY = "anchored_landscape_invoice_v1";
    const PWA_STORE_KEY = "anchored_landscape_pwa_settings_v1";

    const fmt = new Intl.NumberFormat("en-US", { style:"currency", currency:"USD" });
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const num = (v) => {
      const x = parseFloat(v);
      return Number.isFinite(x) ? x : 0;
    };

    function todayISO(){
      const d = new Date();
      const tzOff = d.getTimezoneOffset() * 60000;
      return new Date(Date.now() - tzOff).toISOString().slice(0,10);
    }

    function newInvoiceNumber(){
      const d = new Date();
      const y = d.getFullYear().toString().slice(-2);
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const rand = Math.floor(Math.random()*900 + 100); // 100-999
      return `AL-${y}${m}${day}-${rand}`;
    }

    const DEFAULT_STATE = {
      biz: {
        name: "Anchored Landscaping LLC",
        phone: "217-597-8466",
        address: "303 James St, Saint Joseph, IL 61873"
      },
      invoice: {
        no: "",
        date: "",
        status: "Unpaid",
        custName: "",
        custPhone: "",
        custEmail: "",
        custAddress: "",
        notes: ""
      },
      totals: {
        taxPct: 0,
        discountAmt: 0
      },
      assistant: {
        laborRate: 55,
        overheadPct: 12,
        profitPct: 20,
        travelMins: 20,
        helperMins: 10,

        // production rates
        mowSqftHr: 12000,
        edgeLfHr: 900,
        weedSqftHr: 600,

        mulchCuydHr: 2.0,
        rockTonHr: 1.2,
        soilCuydHr: 2.0,

        sodSqftHr: 500,
        hedgeLfHr: 250,
        bushPerHr: 10,

        leafSqftHr: 2500,

        // materials
        dumpFee: 45,
        supplies: 10,
        mulchMat: 42,
        rockMat: 55,
        soilMat: 38,
        sodMat: 0.55,

        minJobFee: 45
      },
      items: [] // filled below
    };

    const DEFAULT_SERVICES = [
      { id: cryptoId(), service:"Mowing", unit:"per cut", qty:1, rate:55, measureType:"mow", measures:{ sqft: 6000 }, enabled:true },
      { id: cryptoId(), service:"Trimming/Edging", unit:"flat", qty:1, rate:35, measureType:"edge", measures:{ linearft: 200 }, enabled:true },
      { id: cryptoId(), service:"Mulch install", unit:"cubic yard", qty:2, rate:85, measureType:"mulch", measures:{ cuyd: 2 }, enabled:true },
      { id: cryptoId(), service:"Rock/Gravel", unit:"ton", qty:1, rate:110, measureType:"rock", measures:{ tons: 1 }, enabled:true },
      { id: cryptoId(), service:"Soil/Topsoil", unit:"yard", qty:2, rate:75, measureType:"soil", measures:{ cuyd: 2 }, enabled:true },
      { id: cryptoId(), service:"Sod install", unit:"sq ft", qty:500, rate:1.25, measureType:"sod", measures:{ sqft: 500 }, enabled:true },
      { id: cryptoId(), service:"Leaf cleanup", unit:"hour", qty:2, rate:65, measureType:"leaf", measures:{ sqft: 6000 }, enabled:true },
      { id: cryptoId(), service:"Bush trimming", unit:"per bush", qty:8, rate:12, measureType:"bush", measures:{ count: 8 }, enabled:true },
      { id: cryptoId(), service:"Hedge trimming", unit:"linear ft", qty:60, rate:3.25, measureType:"hedge", measures:{ linearft: 60 }, enabled:true },
      { id: cryptoId(), service:"Spring/Fall cleanup", unit:"flat", qty:1, rate:220, measureType:"cleanup", measures:{ sqft: 8000 }, enabled:true },
      { id: cryptoId(), service:"Weeding", unit:"hour", qty:2, rate:60, measureType:"weed", measures:{ sqft: 1200 }, enabled:true },
      { id: cryptoId(), service:"Haul-away/Dump fee", unit:"flat", qty:1, rate:45, measureType:"haul", measures:{ }, enabled:true },
    ];

    function cryptoId(){
      if (crypto?.randomUUID) return crypto.randomUUID();
      return "id-" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed;
      }catch(e){
        return null;
      }
    }
    function saveState(state){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
    }

    function mergeDefaults(partial){
      const s = structuredClone(DEFAULT_STATE);

      // items default
      s.items = structuredClone(DEFAULT_SERVICES);

      if(!partial) return s;

      // shallow merges
      if(partial.biz) s.biz = { ...s.biz, ...partial.biz };
      if(partial.invoice) s.invoice = { ...s.invoice, ...partial.invoice };
      if(partial.totals) s.totals = { ...s.totals, ...partial.totals };
      if(partial.assistant) s.assistant = { ...s.assistant, ...partial.assistant };

      // items: accept saved items if present
      if(Array.isArray(partial.items) && partial.items.length){
        s.items = partial.items.map(it => ({
          id: it.id || cryptoId(),
          service: it.service ?? "Service",
          unit: it.unit ?? "flat",
          qty: Number.isFinite(+it.qty) ? +it.qty : 1,
          rate: Number.isFinite(+it.rate) ? +it.rate : 0,
          measureType: it.measureType ?? "custom",
          measures: it.measures ?? {},
          enabled: it.enabled !== false
        }));
      }
      return s;
    }

    let STATE = mergeDefaults(loadState());

    /***********************
     * UI refs
     ***********************/
    const $ = (id) => document.getElementById(id);

    const refs = {
      invoiceNo: $("invoiceNo"),
      jobDate: $("jobDate"),
      status: $("status"),
      custName: $("custName"),
      custPhone: $("custPhone"),
      custEmail: $("custEmail"),
      custAddress: $("custAddress"),
      notes: $("notes"),

      bizName: $("bizName"),
      bizPhone: $("bizPhone"),
      bizAddress: $("bizAddress"),

      setLaborRate: $("setLaborRate"),
      setOverheadPct: $("setOverheadPct"),
      setProfitPct: $("setProfitPct"),
      setTravelMins: $("setTravelMins"),
      setMinJobFee: $("setMinJobFee"),
      setHelperMins: $("setHelperMins"),

      rateMowSqftHr: $("rateMowSqftHr"),
      rateEdgeLfHr: $("rateEdgeLfHr"),
      rateWeedSqftHr: $("rateWeedSqftHr"),
      rateMulchCuydHr: $("rateMulchCuydHr"),
      rateRockTonHr: $("rateRockTonHr"),
      rateSoilCuydHr: $("rateSoilCuydHr"),
      rateSodSqftHr: $("rateSodSqftHr"),
      rateHedgeLfHr: $("rateHedgeLfHr"),
      rateBushPerHr: $("rateBushPerHr"),
      rateLeafSqftHr: $("rateLeafSqftHr"),

      matDumpFee: $("matDumpFee"),
      matSupplies: $("matSupplies"),
      matMulch: $("matMulch"),
      matRock: $("matRock"),
      matSoil: $("matSoil"),
      matSod: $("matSod"),

      taxPct: $("taxPct"),
      discountAmt: $("discountAmt"),

      itemsBody: $("itemsBody"),

      subTotal: $("subTotal"),
      taxTotal: $("taxTotal"),
      grandTotal: $("grandTotal"),

      btnNewInvoice: $("btnNewInvoice"),
      btnSave: $("btnSave"),
      btnExport: $("btnExport"),
      btnResetAll: $("btnResetAll"),
      btnAddCustom: $("btnAddCustom"),
      btnAddDefaults: $("btnAddDefaults"),
      btnQuoteEmail: $("btnQuoteEmail"),

      appTitle: $("appTitle"),
      appSub: $("appSub"),
    };

    /***********************
     * Pricing Assistant
     ***********************/
    function hoursFromProduction(amount, perHour){
      const ph = Math.max(1e-6, num(perHour));
      return Math.max(0, num(amount) / ph);
    }

    function calcSuggestedForItem(item){
      const A = STATE.assistant;
      const laborRate = num(A.laborRate);
      const overheadPct = clamp(num(A.overheadPct)/100, 0, 0.95);
      const profitPct = clamp(num(A.profitPct)/100, 0, 2.0); // allow >100% markup if desired
      const travelHrs = Math.max(0, num(A.travelMins))/60;
      const helperHrs = Math.max(0, num(A.helperMins))/60;

      // Base "per job" extras
      const supplies = Math.max(0, num(A.supplies));
      let material = 0;
      let laborHrs = 0;
      let noteBits = [];

      const mt = item.measureType;
      const m = item.measures || {};

      if(mt === "mow"){
        const sqft = Math.max(0, num(m.sqft));
        laborHrs += hoursFromProduction(sqft, A.mowSqftHr);
        noteBits.push(`Mow: ${sqft.toLocaleString()} sq ft`);
      } else if(mt === "edge"){
        const lf = Math.max(0, num(m.linearft));
        laborHrs += hoursFromProduction(lf, A.edgeLfHr);
        noteBits.push(`Edge: ${lf.toLocaleString()} linear ft`);
      } else if(mt === "weed"){
        const sqft = Math.max(0, num(m.sqft));
        laborHrs += hoursFromProduction(sqft, A.weedSqftHr);
        noteBits.push(`Weed: ${sqft.toLocaleString()} sq ft`);
      } else if(mt === "mulch"){
        const cuyd = Math.max(0, num(m.cuyd));
        laborHrs += hoursFromProduction(cuyd, A.mulchCuydHr);
        material += cuyd * Math.max(0, num(A.mulchMat));
        noteBits.push(`Mulch: ${cuyd} cu yd`);
      } else if(mt === "rock"){
        const tons = Math.max(0, num(m.tons));
        laborHrs += hoursFromProduction(tons, A.rockTonHr);
        material += tons * Math.max(0, num(A.rockMat));
        noteBits.push(`Rock: ${tons} tons`);
      } else if(mt === "soil"){
        const cuyd = Math.max(0, num(m.cuyd));
        laborHrs += hoursFromProduction(cuyd, A.soilCuydHr);
        material += cuyd * Math.max(0, num(A.soilMat));
        noteBits.push(`Soil: ${cuyd} cu yd`);
      } else if(mt === "sod"){
        const sqft = Math.max(0, num(m.sqft));
        laborHrs += hoursFromProduction(sqft, A.sodSqftHr);
        material += sqft * Math.max(0, num(A.sodMat));
        noteBits.push(`Sod: ${sqft.toLocaleString()} sq ft`);
      } else if(mt === "hedge"){
        const lf = Math.max(0, num(m.linearft));
        laborHrs += hoursFromProduction(lf, A.hedgeLfHr);
        noteBits.push(`Hedge: ${lf.toLocaleString()} linear ft`);
      } else if(mt === "bush"){
        const count = Math.max(0, num(m.count));
        laborHrs += hoursFromProduction(count, A.bushPerHr);
        noteBits.push(`Bushes: ${count}`);
      } else if(mt === "leaf"){
        const sqft = Math.max(0, num(m.sqft));
        // leaf cleanup can also be manually estimated via qty (hours) if unit is hour
        laborHrs += hoursFromProduction(sqft, A.leafSqftHr);
        noteBits.push(`Leaf area: ${sqft.toLocaleString()} sq ft`);
      } else if(mt === "cleanup"){
        // spring/fall cleanup: treat as leaf/weed blend using sqft
        const sqft = Math.max(0, num(m.sqft));
        const leafH = hoursFromProduction(sqft, A.leafSqftHr);
        const weedH = hoursFromProduction(sqft * 0.15, A.weedSqftHr); // small portion
        laborHrs += leafH + weedH;
        noteBits.push(`Cleanup area: ${sqft.toLocaleString()} sq ft`);
      } else if(mt === "haul"){
        material += Math.max(0, num(A.dumpFee));
        noteBits.push(`Dump fee`);
      } else {
        // custom: if user puts qty hours and unit is hour, we use that as labor hours
        if((item.unit || "").toLowerCase().includes("hour")){
          laborHrs += Math.max(0, num(item.qty));
          noteBits.push(`Hours: ${Math.max(0,num(item.qty))}`);
        }
      }

      // Add helper + travel to labor hours (per line suggestion)
      // If the line is purely "haul/dump fee", keep helper/travel smaller:
      const isHaul = (mt === "haul");
      const extraLabor = isHaul ? (travelHrs * 0.5 + helperHrs * 0.25) : (travelHrs + helperHrs);
      laborHrs += extraLabor;

      const labor = laborHrs * laborRate;

      const baseCost = labor + material + supplies;
      const overhead = baseCost * overheadPct;
      const costWithOverhead = baseCost + overhead;
      const suggestedTotal = Math.max(num(A.minJobFee), costWithOverhead * (1 + profitPct));

      const qty = Math.max(0, num(item.qty));
      const perUnit = qty > 0 ? (suggestedTotal / qty) : suggestedTotal;

      // Undercharge check vs current line
      const currentLine = qty * Math.max(0, num(item.rate));
      const marginGap = suggestedTotal - currentLine;

      return {
        suggestedTotal,
        suggestedRate: perUnit,
        breakdown: {
          laborHrs,
          labor,
          material,
          supplies,
          overhead,
          costWithOverhead,
          profit: costWithOverhead * profitPct,
          note: noteBits.join(" ‚Ä¢ ")
        },
        marginGap
      };
    }

    /***********************
     * Render Items
     ***********************/
    function measurementEditorHTML(item){
      const mt = item.measureType;
      const m = item.measures || {};

      const input = (key, label, placeholder="0", step="1") => `
        <div style="display:grid; gap:6px; margin-top:6px;">
          <div class="cellMini">${label}</div>
          <input data-mid="${item.id}" data-mkey="${key}" type="number" step="${step}" value="${escapeAttr(m[key] ?? "")}" placeholder="${placeholder}" />
        </div>
      `;

      const select = `
        <div style="display:grid; gap:6px;">
          <div class="cellMini">Type</div>
          <select data-mid="${item.id}" data-mtype="1">
            ${[
              ["mow","Mowing (sq ft)"],
              ["edge","Trimming/Edging (linear ft)"],
              ["mulch","Mulch (cu yd)"],
              ["rock","Rock/Gravel (tons)"],
              ["soil","Soil/Topsoil (cu yd)"],
              ["sod","Sod (sq ft)"],
              ["leaf","Leaf cleanup (sq ft)"],
              ["bush","Bush trimming (count)"],
              ["hedge","Hedge trimming (linear ft)"],
              ["cleanup","Spring/Fall cleanup (sq ft)"],
              ["weed","Weeding (sq ft)"],
              ["haul","Haul-away/Dump fee"],
              ["custom","Custom (hours if unit=hour)"],
            ].map(([v,t])=>`<option value="${v}" ${v===mt?"selected":""}>${t}</option>`).join("")}
          </select>
        </div>
      `;

      let fields = "";
      if(mt==="mow") fields = input("sqft","Area (sq ft)","6000","1");
      else if(mt==="edge") fields = input("linearft","Length (linear ft)","200","1");
      else if(mt==="mulch") fields = input("cuyd","Volume (cubic yards)","2","0.01");
      else if(mt==="rock") fields = input("tons","Weight (tons)","1","0.01");
      else if(mt==="soil") fields = input("cuyd","Volume (cubic yards)","2","0.01");
      else if(mt==="sod") fields = input("sqft","Area (sq ft)","500","1");
      else if(mt==="leaf") fields = input("sqft","Area (sq ft)","6000","1");
      else if(mt==="bush") fields = input("count","Bush count","8","1");
      else if(mt==="hedge") fields = input("linearft","Length (linear ft)","60","1");
      else if(mt==="cleanup") fields = input("sqft","Area (sq ft)","8000","1");
      else if(mt==="weed") fields = input("sqft","Area (sq ft)","1200","1");
      else if(mt==="haul") fields = `<div class="cellMini" style="margin-top:6px;">Uses dump fee setting by default.</div>`;
      else fields = `<div class="cellMini" style="margin-top:6px;">If unit is ‚Äúhour‚Äù, quantity will be treated as labor hours for suggestions.</div>`;

      return `<div style="min-width:240px;">${select}${fields}</div>`;
    }

    function escapeHtml(s){
      return (s ?? "").toString().replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function escapeAttr(s){
      return escapeHtml(s).replace(/"/g, "&quot;");
    }

    function renderItems(){
      refs.itemsBody.innerHTML = "";

      STATE.items.forEach((item, idx) => {
        const qty = Math.max(0, num(item.qty));
        const rate = Math.max(0, num(item.rate));
        const line = qty * rate;

        const sug = calcSuggestedForItem(item);
        const sugRate = sug.suggestedRate;
        const sugTotal = sug.suggestedTotal;

        const gap = sug.marginGap;
        const badge = gap <= 1
          ? `<span class="pill good">‚úì Near suggestion</span>`
          : gap < 0
            ? `<span class="pill good">‚úì Above suggestion</span>`
            : gap < 25
              ? `<span class="pill warn">‚ö† Slightly low</span>`
              : `<span class="pill bad">‚¨á Likely underpriced</span>`;

        const breakdown = `
          <div class="cellMini">
            ${badge}
            <div style="margin-top:6px;">
              <div><b>Suggested total:</b> ${fmt.format(sugTotal)}</div>
              <div><b>Suggested rate:</b> ${fmt.format(sugRate)} <span class="muted">/ ${escapeHtml(item.unit)}</span></div>
            </div>
            <div style="margin-top:6px;">
              <span class="muted">${escapeHtml(sug.breakdown.note || "")}</span>
            </div>
            <details style="margin-top:8px;">
              <summary class="muted" style="cursor:pointer;">View breakdown</summary>
              <div class="cellMini" style="margin-top:8px;">
                Labor: ${sug.breakdown.laborHrs.toFixed(2)} hrs √ó ${fmt.format(num(STATE.assistant.laborRate))} = <b>${fmt.format(sug.breakdown.labor)}</b><br/>
                Material: <b>${fmt.format(sug.breakdown.material)}</b><br/>
                Supplies/misc: <b>${fmt.format(sug.breakdown.supplies)}</b><br/>
                Overhead (${num(STATE.assistant.overheadPct).toFixed(1)}%): <b>${fmt.format(sug.breakdown.overhead)}</b><br/>
                Profit (${num(STATE.assistant.profitPct).toFixed(1)}%): <b>${fmt.format(sug.breakdown.profit)}</b><br/>
                <div style="margin-top:6px;">Cost+OH: ${fmt.format(sug.breakdown.costWithOverhead)}</div>
              </div>
            </details>
          </div>
        `;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="display:grid; gap:6px;">
              <input data-id="${item.id}" data-field="service" value="${escapeAttr(item.service)}" />
              <div class="cellMini">
                Unit:
                <select data-id="${item.id}" data-field="unit">
                  ${["per cut","flat","cubic yard","ton","yard","sq ft","hour","per bush","linear ft"].map(u => `
                    <option value="${u}" ${u===item.unit?"selected":""}>${u}</option>
                  `).join("")}
                </select>
              </div>
            </div>
          </td>

          <td>${measurementEditorHTML(item)}</td>

          <td>
            <input data-id="${item.id}" data-field="qty" type="number" step="0.01" value="${escapeAttr(item.qty)}" />
            <div class="cellMini">Qty in units above</div>
          </td>

          <td>
            <input data-id="${item.id}" data-field="rate" type="number" step="0.01" value="${escapeAttr(item.rate)}" />
            <div class="cellMini">Rate per unit</div>
          </td>

          <td>
            <div style="font-weight:900;">${fmt.format(line)}</div>
            <div class="cellMini">Auto = Qty √ó Rate</div>
          </td>

          <td>
            ${breakdown}
            <div class="actions noPrint" style="margin-top:8px;">
              <button class="btn small primary" data-act="useSugRate" data-id="${item.id}" type="button">Use Suggestion</button>
              <button class="btn small" data-act="useSugTotal" data-id="${item.id}" type="button">Use Total as Flat</button>
            </div>
          </td>

          <td class="noPrint">
            <div class="actions" style="flex-direction:column; align-items:stretch;">
              <button class="btn small danger" data-act="remove" data-id="${item.id}" type="button">Remove</button>
            </div>
          </td>
        `;
        refs.itemsBody.appendChild(tr);
      });

      recalcTotals();
    }

    function recalcTotals(){
      const sub = STATE.items.reduce((sum, it) => {
        const qty = Math.max(0, num(it.qty));
        const rate = Math.max(0, num(it.rate));
        return sum + qty*rate;
      }, 0);

      const taxPct = clamp(num(STATE.totals.taxPct)/100, 0, 0.25);
      const tax = sub * taxPct;

      const discount = Math.max(0, num(STATE.totals.discountAmt));
      const grand = Math.max(0, sub + tax - discount);

      refs.subTotal.textContent = fmt.format(sub);
      refs.taxTotal.textContent = fmt.format(tax);
      refs.grandTotal.textContent = fmt.format(grand);
    }

    /***********************
     * Bind form -> state
     ***********************/
    function syncHeader(){
      refs.appTitle.textContent = `${STATE.biz.name} ‚Äî Invoice`;
      refs.appSub.textContent = `${STATE.biz.phone} ‚Ä¢ ${STATE.biz.address}`;
      document.title = `${STATE.biz.name} Invoice`;
    }

    function populateForm(){
      // invoice
      refs.invoiceNo.value = STATE.invoice.no || "";
      refs.jobDate.value = STATE.invoice.date || "";
      refs.status.value = STATE.invoice.status || "Unpaid";
      refs.custName.value = STATE.invoice.custName || "";
      refs.custPhone.value = STATE.invoice.custPhone || "";
      refs.custEmail.value = STATE.invoice.custEmail || "";
      refs.custAddress.value = STATE.invoice.custAddress || "";
      refs.notes.value = STATE.invoice.notes || "";

      // biz
      refs.bizName.value = STATE.biz.name || "";
      refs.bizPhone.value = STATE.biz.phone || "";
      refs.bizAddress.value = STATE.biz.address || "";

      // totals
      refs.taxPct.value = STATE.totals.taxPct ?? 0;
      refs.discountAmt.value = STATE.totals.discountAmt ?? 0;

      // assistant settings
      const A = STATE.assistant;
      refs.setLaborRate.value = A.laborRate ?? 0;
      refs.setOverheadPct.value = A.overheadPct ?? 0;
      refs.setProfitPct.value = A.profitPct ?? 0;
      refs.setTravelMins.value = A.travelMins ?? 0;
      refs.setMinJobFee.value = A.minJobFee ?? 0;
      refs.setHelperMins.value = A.helperMins ?? 0;

      refs.rateMowSqftHr.value = A.mowSqftHr ?? 0;
      refs.rateEdgeLfHr.value = A.edgeLfHr ?? 0;
      refs.rateWeedSqftHr.value = A.weedSqftHr ?? 0;

      refs.rateMulchCuydHr.value = A.mulchCuydHr ?? 0;
      refs.rateRockTonHr.value = A.rockTonHr ?? 0;
      refs.rateSoilCuydHr.value = A.soilCuydHr ?? 0;

      refs.rateSodSqftHr.value = A.sodSqftHr ?? 0;
      refs.rateHedgeLfHr.value = A.hedgeLfHr ?? 0;
      refs.rateBushPerHr.value = A.bushPerHr ?? 0;

      refs.rateLeafSqftHr.value = A.leafSqftHr ?? 0;

      refs.matDumpFee.value = A.dumpFee ?? 0;
      refs.matSupplies.value = A.supplies ?? 0;

      refs.matMulch.value = A.mulchMat ?? 0;
      refs.matRock.value = A.rockMat ?? 0;
      refs.matSoil.value = A.soilMat ?? 0;
      refs.matSod.value = A.sodMat ?? 0;

      syncHeader();
      renderItems();
    }

    function wireInputs(){
      // invoice fields
      const invMap = [
        ["invoiceNo","no"],["jobDate","date"],["status","status"],
        ["custName","custName"],["custPhone","custPhone"],["custEmail","custEmail"],["custAddress","custAddress"],
        ["notes","notes"]
      ];
      invMap.forEach(([id,key])=>{
        $(id).addEventListener("input", ()=>{
          STATE.invoice[key] = $(id).value;
          autoSave();
        });
        $(id).addEventListener("change", ()=>{
          STATE.invoice[key] = $(id).value;
          autoSave();
        });
      });

      // business
      refs.bizName.addEventListener("input", ()=>{ STATE.biz.name = refs.bizName.value; syncHeader(); autoSave(); });
      refs.bizPhone.addEventListener("input", ()=>{ STATE.biz.phone = refs.bizPhone.value; syncHeader(); autoSave(); });
      refs.bizAddress.addEventListener("input", ()=>{ STATE.biz.address = refs.bizAddress.value; syncHeader(); autoSave(); });

      // totals
      refs.taxPct.addEventListener("input", ()=>{ STATE.totals.taxPct = num(refs.taxPct.value); recalcTotals(); autoSave(); });
      refs.discountAmt.addEventListener("input", ()=>{ STATE.totals.discountAmt = num(refs.discountAmt.value); recalcTotals(); autoSave(); });

      // assistant: common handler
      const bindA = (el, key) => {
        el.addEventListener("input", ()=>{
          STATE.assistant[key] = num(el.value);
          renderItems(); // suggestions + totals refresh
          autoSave();
        });
      };

      bindA(refs.setLaborRate, "laborRate");
      bindA(refs.setOverheadPct, "overheadPct");
      bindA(refs.setProfitPct, "profitPct");
      bindA(refs.setTravelMins, "travelMins");
      bindA(refs.setMinJobFee, "minJobFee");
      bindA(refs.setHelperMins, "helperMins");

      bindA(refs.rateMowSqftHr, "mowSqftHr");
      bindA(refs.rateEdgeLfHr, "edgeLfHr");
      bindA(refs.rateWeedSqftHr, "weedSqftHr");

      bindA(refs.rateMulchCuydHr, "mulchCuydHr");
      bindA(refs.rateRockTonHr, "rockTonHr");
      bindA(refs.rateSoilCuydHr, "soilCuydHr");

      bindA(refs.rateSodSqftHr, "sodSqftHr");
      bindA(refs.rateHedgeLfHr, "hedgeLfHr");
      bindA(refs.rateBushPerHr, "bushPerHr");
      bindA(refs.rateLeafSqftHr, "leafSqftHr");

      bindA(refs.matDumpFee, "dumpFee");
      bindA(refs.matSupplies, "supplies");
      bindA(refs.matMulch, "mulchMat");
      bindA(refs.matRock, "rockMat");
      bindA(refs.matSoil, "soilMat");
      bindA(refs.matSod, "sodMat");
    }

    function autoSave(){
      // keep small; save on every edit is fine for localStorage
      saveState(STATE);
    }

    /***********************
     * Table events (delegation)
     ***********************/
    function findItem(id){
      return STATE.items.find(x => x.id === id);
    }

    refs.itemsBody.addEventListener("input", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;

      // service/unit/qty/rate
      const id = t.getAttribute("data-id");
      const field = t.getAttribute("data-field");
      if(id && field){
        const item = findItem(id);
        if(!item) return;
        if(field === "service") item.service = t.value;
        if(field === "unit") item.unit = t.value;
        if(field === "qty") item.qty = num(t.value);
        if(field === "rate") item.rate = num(t.value);
        renderItems();
        autoSave();
        return;
      }

      // measure inputs
      const mid = t.getAttribute("data-mid");
      const mkey = t.getAttribute("data-mkey");
      if(mid && mkey){
        const item = findItem(mid);
        if(!item) return;
        item.measures = item.measures || {};
        item.measures[mkey] = num(t.value);
        renderItems();
        autoSave();
        return;
      }
    });

    refs.itemsBody.addEventListener("change", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;

      // measure type selector
      const mid = t.getAttribute("data-mid");
      const isType = t.getAttribute("data-mtype");
      if(mid && isType){
        const item = findItem(mid);
        if(!item) return;
        item.measureType = t.value;
        // reset measures defaults lightly
        const mt = item.measureType;
        item.measures = {};
        if(mt==="mow" || mt==="sod" || mt==="leaf" || mt==="cleanup" || mt==="weed") item.measures.sqft = 0;
        if(mt==="edge" || mt==="hedge") item.measures.linearft = 0;
        if(mt==="mulch" || mt==="soil") item.measures.cuyd = 0;
        if(mt==="rock") item.measures.tons = 0;
        if(mt==="bush") item.measures.count = 0;

        renderItems();
        autoSave();
        return;
      }

      // unit dropdown
      const id = t.getAttribute("data-id");
      const field = t.getAttribute("data-field");
      if(id && field){
        const item = findItem(id);
        if(!item) return;
        if(field === "unit") item.unit = t.value;
        renderItems();
        autoSave();
      }
    });

    refs.itemsBody.addEventListener("click", (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLElement)) return;
      const act = t.getAttribute("data-act");
      const id = t.getAttribute("data-id");
      if(!act || !id) return;

      const item = findItem(id);
      if(!item) return;

      if(act === "remove"){
        STATE.items = STATE.items.filter(x => x.id !== id);
        renderItems();
        autoSave();
        return;
      }

      const sug = calcSuggestedForItem(item);

      if(act === "useSugRate"){
        item.rate = Math.max(0, sug.suggestedRate);
        renderItems();
        autoSave();
        return;
      }

      if(act === "useSugTotal"){
        // make it a flat line: qty=1 and unit=flat
        item.unit = "flat";
        item.qty = 1;
        item.rate = Math.max(0, sug.suggestedTotal);
        renderItems();
        autoSave();
        return;
      }
    });

    /***********************
     * Buttons
     ***********************/
    refs.btnAddCustom.addEventListener("click", ()=>{
      STATE.items.push({
        id: cryptoId(),
        service: "Custom service",
        unit: "flat",
        qty: 1,
        rate: 0,
        measureType: "custom",
        measures: {},
        enabled: true
      });
      renderItems();
      autoSave();
    });

    refs.btnAddDefaults.addEventListener("click", ()=>{
      // restore default services (replaces current)
      STATE.items = structuredClone(DEFAULT_SERVICES).map(it => ({...it, id: cryptoId()}));
      renderItems();
      autoSave();
    });

    refs.btnNewInvoice.addEventListener("click", ()=>{
      STATE.invoice.no = newInvoiceNumber();
      STATE.invoice.date = todayISO();
      STATE.invoice.status = "Unpaid";
      STATE.invoice.custName = "";
      STATE.invoice.custPhone = "";
      STATE.invoice.custEmail = "";
      STATE.invoice.custAddress = "";
      STATE.invoice.notes = "";
      STATE.totals.discountAmt = 0;

      populateForm();
      autoSave();
    });

    refs.btnSave.addEventListener("click", ()=>{
      autoSave();
      alert("Saved on this device.");
    });

    refs.btnExport.addEventListener("click", ()=>{
      window.print();
    });

    refs.btnResetAll.addEventListener("click", ()=>{
      const ok = confirm("Reset everything (business info, settings, invoice, items) on this device?");
      if(!ok) return;
      localStorage.removeItem(STORE_KEY);
      STATE = mergeDefaults(null);
      // set fresh invoice
      STATE.invoice.no = newInvoiceNumber();
      STATE.invoice.date = todayISO();
      saveState(STATE);
      populateForm();
      alert("Reset complete.");
    });

    refs.btnQuoteEmail.addEventListener("click", async ()=>{
      const sub = STATE.items.reduce((sum, it)=> sum + Math.max(0,num(it.qty))*Math.max(0,num(it.rate)), 0);
      const tax = sub * clamp(num(STATE.totals.taxPct)/100, 0, 0.25);
      const discount = Math.max(0, num(STATE.totals.discountAmt));
      const grand = Math.max(0, sub + tax - discount);

      const lines = STATE.items.map(it=>{
        const qty = Math.max(0,num(it.qty));
        const rate = Math.max(0,num(it.rate));
        const line = qty*rate;
        return `‚Ä¢ ${it.service} ‚Äî ${qty} ${it.unit} √ó ${rate.toFixed(2)} = ${line.toFixed(2)}`;
      });

      const text =
`${STATE.biz.name}
${STATE.biz.phone} | ${STATE.biz.address}

Invoice: ${STATE.invoice.no}
Date: ${STATE.invoice.date}
Status: ${STATE.invoice.status}

Customer: ${STATE.invoice.custName}
Address: ${STATE.invoice.custAddress}

Items:
${lines.join("\n")}

Subtotal: ${sub.toFixed(2)}
Tax (${num(STATE.totals.taxPct).toFixed(1)}%): ${tax.toFixed(2)}
Discount: ${discount.toFixed(2)}
TOTAL: ${grand.toFixed(2)}

Notes:
${STATE.invoice.notes}`.trim();

      try{
        await navigator.clipboard.writeText(text);
        alert("Summary copied to clipboard.");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        alert("Summary copied.");
      }
    });

    /***********************
     * Init invoice defaults
     ***********************/
    function ensureInvoiceDefaults(){
      if(!STATE.invoice.no) STATE.invoice.no = newInvoiceNumber();
      if(!STATE.invoice.date) STATE.invoice.date = todayISO();
    }

    /**********************************************************************
     * PWA (single-file) ‚Äî dynamic manifest + inline service worker + icon change
     **********************************************************************/
    function defaultIconDataUrl() {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#22c55e"/>
              <stop offset="1" stop-color="#111827"/>
            </linearGradient>
          </defs>
          <rect width="512" height="512" rx="96" fill="url(#g)"/>
          <g fill="#e5e7eb" opacity="0.96">
            <path d="M256 110c-68 0-124 56-124 124 0 41 20 78 52 101v57c0 11 9 20 20 20h104c11 0 20-9 20-20v-57c32-23 52-60 52-101 0-68-56-124-124-124zm62 212-22 16v54H216v-54l-22-16c-26-18-42-48-42-80 0-57 47-104 104-104s104 47 104 104c0 32-16 62-42 80z"/>
            <rect x="212" y="404" width="88" height="22" rx="11"/>
          </g>
        </svg>
      `.trim();
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    function loadPwaSettings() {
      try {
        const raw = localStorage.getItem(PWA_STORE_KEY);
        if (!raw) return { name: `${STATE.biz.name} Invoice`, iconUrl: "" };
        const parsed = JSON.parse(raw);
        return {
          name: (parsed.name || `${STATE.biz.name} Invoice`).toString(),
          iconUrl: (parsed.iconUrl || "").toString()
        };
      } catch {
        return { name: `${STATE.biz.name} Invoice`, iconUrl: "" };
      }
    }
    function savePwaSettings(settings) {
      localStorage.setItem(PWA_STORE_KEY, JSON.stringify(settings));
    }

    let currentManifestObjectUrl = null;

    function buildManifest(settings) {
      const iconUrl = settings.iconUrl?.trim() || defaultIconDataUrl();
      const name = settings.name?.trim() || `${STATE.biz.name} Invoice`;

      if (currentManifestObjectUrl) {
        URL.revokeObjectURL(currentManifestObjectUrl);
        currentManifestObjectUrl = null;
      }

      const manifest = {
        name,
        short_name: name.length > 12 ? name.slice(0, 12) : name,
        start_url: "./",
        scope: "./",
        display: "standalone",
        background_color: "#0b1220",
        theme_color: "#111827",
        icons: [
          { src: iconUrl, sizes: "192x192", type: iconUrl.startsWith("data:image/svg") ? "image/svg+xml" : "image/png", purpose: "any maskable" },
          { src: iconUrl, sizes: "512x512", type: iconUrl.startsWith("data:image/svg") ? "image/svg+xml" : "image/png", purpose: "any maskable" }
        ]
      };

      const blob = new Blob([JSON.stringify(manifest)], { type: "application/manifest+json" });
      currentManifestObjectUrl = URL.createObjectURL(blob);

      let link = document.querySelector('link[rel="manifest"]');
      if (!link) {
        link = document.createElement("link");
        link.rel = "manifest";
        document.head.appendChild(link);
      }
      link.href = currentManifestObjectUrl;

      // update previews
      const iconPreview = document.getElementById("pwaIconPreview");
      const namePreview = document.getElementById("pwaNamePreview");
      const iconPreviewText = document.getElementById("pwaIconPreviewText");
      if (iconPreview) iconPreview.src = iconUrl;
      if (namePreview) namePreview.textContent = name;
      if (iconPreviewText) iconPreviewText.textContent = settings.iconUrl?.trim() ? "Using your icon URL" : "Using default icon";
    }

    async function registerInlineServiceWorker(iconUrlToCache) {
      if (!("serviceWorker" in navigator)) return;

      const swCode = `
        const CACHE = "anchored-landscape-invoice-cache-v1";
        self.addEventListener("install", (event) => {
          event.waitUntil((async () => {
            const cache = await caches.open(CACHE);
            await cache.addAll(["./"]);
          })());
          self.skipWaiting();
        });

        self.addEventListener("activate", (event) => {
          event.waitUntil((async () => {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => k === CACHE ? null : caches.delete(k)));
            await self.clients.claim();
          })());
        });

        self.addEventListener("fetch", (event) => {
          const req = event.request;
          if (req.method !== "GET") return;

          event.respondWith((async () => {
            const cache = await caches.open(CACHE);
            const cached = await cache.match(req);
            if (cached) return cached;

            try {
              const fresh = await fetch(req);
              if (fresh && fresh.ok) cache.put(req, fresh.clone());
              return fresh;
            } catch (e) {
              if (req.mode === "navigate") {
                const fallback = await cache.match("./");
                if (fallback) return fallback;
              }
              throw e;
            }
          })());
        });

        self.addEventListener("message", (event) => {
          const data = event.data || {};
          if (data.type === "PRECACHE_URL" && data.url) {
            event.waitUntil((async () => {
              try{
                const cache = await caches.open(CACHE);
                await cache.add(data.url);
              }catch(e){}
            })());
          }
        });
      `.trim();

      const blob = new Blob([swCode], { type: "text/javascript" });
      const swUrl = URL.createObjectURL(blob);

      try {
        const reg = await navigator.serviceWorker.register(swUrl, { scope: "./" });
        setTimeout(() => URL.revokeObjectURL(swUrl), 5000);

        if (iconUrlToCache && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: "PRECACHE_URL", url: iconUrlToCache });
        } else {
          setTimeout(() => {
            if (iconUrlToCache && navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({ type: "PRECACHE_URL", url: iconUrlToCache });
            }
          }, 1200);
        }
        return reg;
      } catch (e) {
        console.warn("Service worker registration failed:", e);
      }
    }

    // Install prompt
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById("btnInstall");
      if (btn) btn.style.display = "inline-flex";
    });
    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      const btn = document.getElementById("btnInstall");
      if (btn) btn.style.display = "none";
    });
    async function handleInstall(){
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      const btn = document.getElementById("btnInstall");
      if (btn) btn.style.display = "none";
    }

    // PWA modal UI
    function openPwaModal() {
      const backdrop = document.getElementById("pwaModalBackdrop");
      if (backdrop) backdrop.style.display = "flex";
      const s = loadPwaSettings();
      const nameInput = document.getElementById("pwaName");
      const iconInput = document.getElementById("pwaIconUrl");
      if (nameInput) nameInput.value = s.name || "";
      if (iconInput) iconInput.value = s.iconUrl || "";
      buildManifest(s);
    }
    function closePwaModal(){
      const backdrop = document.getElementById("pwaModalBackdrop");
      if (backdrop) backdrop.style.display = "none";
    }
    function wirePwaUi(){
      const btnSettings = document.getElementById("btnPwaSettings");
      const btnClose = document.getElementById("btnClosePwa");
      const btnSave = document.getElementById("btnSavePwa");
      const btnReset = document.getElementById("btnResetPwa");
      const btnInstall = document.getElementById("btnInstall");
      const backdrop = document.getElementById("pwaModalBackdrop");

      if(btnSettings) btnSettings.addEventListener("click", openPwaModal);
      if(btnClose) btnClose.addEventListener("click", closePwaModal);
      if(btnInstall) btnInstall.addEventListener("click", handleInstall);
      if(backdrop){
        backdrop.addEventListener("click", (e)=>{
          if(e.target === backdrop) closePwaModal();
        });
      }

      const nameInput = document.getElementById("pwaName");
      const iconInput = document.getElementById("pwaIconUrl");
      const liveUpdate = ()=>{
        buildManifest({
          name: (nameInput?.value || "").trim() || `${STATE.biz.name} Invoice`,
          iconUrl: (iconInput?.value || "").trim()
        });
      };
      if(nameInput) nameInput.addEventListener("input", liveUpdate);
      if(iconInput) iconInput.addEventListener("input", liveUpdate);

      if(btnSave){
        btnSave.addEventListener("click", ()=>{
          const s = {
            name: (nameInput?.value || "").trim() || `${STATE.biz.name} Invoice`,
            iconUrl: (iconInput?.value || "").trim()
          };
          savePwaSettings(s);
          buildManifest(s);

          if ("serviceWorker" in navigator && navigator.serviceWorker.controller) {
            const iconUrl = s.iconUrl?.trim();
            if (iconUrl) navigator.serviceWorker.controller.postMessage({ type: "PRECACHE_URL", url: iconUrl });
          }

          closePwaModal();
          alert("Saved. Refresh for best results. If already installed, you may need to remove & reinstall to update the home screen icon.");
        });
      }
      if(btnReset){
        btnReset.addEventListener("click", ()=>{
          localStorage.removeItem(PWA_STORE_KEY);
          const s = loadPwaSettings();
          if(nameInput) nameInput.value = s.name;
          if(iconInput) iconInput.value = s.iconUrl;
          buildManifest(s);
        });
      }
    }

    /***********************
     * Boot
     ***********************/
    ensureInvoiceDefaults();
    populateForm();
    wireInputs();
    wirePwaUi();

    // Build manifest + SW
    (async function initPwa(){
      const s = loadPwaSettings();
      buildManifest(s);
      await registerInlineServiceWorker(s.iconUrl?.trim() || "");
    })();

    // Save on unload as backup
    window.addEventListener("beforeunload", ()=> autoSave());
  </script>
</body>
</html>
